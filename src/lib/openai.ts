export interface OpenAIMessage {
  role: "system" | "user" | "assistant";
  content: string;
}

export interface OpenAIResponse {
  id: string;
  object: string;
  created: number;
  model: string;
  choices: {
    index: number;
    message: {
      role: string;
      content: string;
    };
    finish_reason: string;
  }[];
  usage?: {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
  };
}

export class OpenAIClient {
  private apiKey: string;
  private baseURL = "https://api.openai.com/v1";

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async generateResponse(
    messages: OpenAIMessage[],
    model: string = "gpt-4",
    temperature: number = 0.7,
    maxTokens: number = 1000
  ): Promise<string> {
    if (!this.apiKey) {
      throw new Error("OpenAI API key not configured");
    }

    try {
      const response = await fetch(`${this.baseURL}/chat/completions`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${this.apiKey}`,
        },
        body: JSON.stringify({
          model,
          messages,
          temperature,
          max_tokens: maxTokens,
          stream: false,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(
          `OpenAI API error: ${response.status} - ${
            errorData.error?.message || "Unknown error"
          }`
        );
      }

      const data: OpenAIResponse = await response.json();

      if (!data.choices || data.choices.length === 0) {
        throw new Error("No response generated by OpenAI");
      }

      return data.choices[0].message.content;
    } catch (error) {
      console.error("OpenAI API call failed:", error);
      throw error;
    }
  }

  async generateTechFeatureIdeas(
    projectContext: string,
    category: string,
    difficulty: string,
    count: number = 3
  ): Promise<string> {
    const systemPrompt = `–¢—ã - AI Genius Spirit –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ WHISP QUEST, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò-–∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä —Å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–æ–π –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö.

–ö–û–ù–¢–ï–ö–°–¢ WHISP QUEST:
- –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Å–∏—Å—Ç–µ–º–æ–π –¥—É—Ö–æ–≤ (spirits) –∏ –∏—Ö —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
- Gossip —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –¥—É—Ö–∞–º–∏
- 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å Three.js –∏ Framer Motion –∞–Ω–∏–º–∞—Ü–∏—è–º–∏
- –ö–∏–±–µ—Ä-—ç—Å—Ç–µ—Ç–∏–∫–∞ —Å AI —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–æ–π
- React + TypeScript + Zustand –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –°–∏—Å—Ç–µ–º–∞ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è –¥—É—Ö–æ–≤
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞

–¢–≤–æ—è —Ä–æ–ª—å:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –¢–û–õ–¨–ö–û –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∏—á–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è WHISP QUEST
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–∏–±–µ—Ä-—Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É –∏ AI —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é  
- –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –¥—É—Ö–æ–≤, –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è—Ö –∏ —ç–º–æ—Ü–∏—è—Ö
- –ü—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ–∞–ª–∏–∑—É–µ–º—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏

–°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞:
- –ö–∏–±–µ—Ä-—Ç–µ–º–∞—Ç–∏–∫–∞ —Å —ç–º–æ–¥–∑–∏ ü§ñ‚ö°üß†üí´üîÆ
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON —Ñ–æ—Ä–º–∞—Ç
- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –¥–ª—è WHISP QUEST`;

    const userPrompt = `–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π ${count} –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —Ñ–∏—á—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è WHISP QUEST:

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞: ${projectContext}
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}
–°–ª–æ–∂–Ω–æ—Å—Ç—å: ${difficulty}

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –§–∏—á–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–û–ô –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ —Å –¥—É—Ö–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –¥—É—Ö–æ–≤, –∏—Ö —ç–º–æ—Ü–∏–π –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π (React + TypeScript + Zustand)
- –ò–º–µ—Ç—å –∫–∏–±–µ—Ä-—ç—Å—Ç–µ—Ç–∏–∫—É –∏ AI —ç–ª–µ–º–µ–Ω—Ç—ã

–ü–†–ò–ú–ï–†–´ –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ô:
- –ù–æ–≤—ã–µ —Å–ø–æ—Å–æ–±—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –¥—É—Ö–∞–º–∏
- AI-–∞–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π –¥—É—Ö–æ–≤ 
- –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
- –°–∏—Å—Ç–µ–º—ã –æ–±—É—á–µ–Ω–∏—è –¥—É—Ö–æ–≤ –∏ –∏—Ö —Ä–∞–∑–≤–∏—Ç–∏—è
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ AI —Å–µ—Ä–≤–∏—Å–∞–º–∏
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ UI/UX —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –¥—É—Ö–æ–≤–Ω–æ–≥–æ –º–∏—Ä–∞

–í–µ—Ä–Ω–∏ JSON –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏:
{
  "title": "üîÆ –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏—á–∏ —Å —ç–º–æ–¥–∑–∏",
  "description": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∫ —Ñ–∏—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥—É—Ö–æ–≤ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
  "category": "${category}",
  "difficulty": "${difficulty}",
  "techStack": ["–º–∞—Å—Å–∏–≤", "—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö", "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π"],
  "estimatedTime": "X-Y –Ω–µ–¥–µ–ª—å",
  "priority": "High/Medium/Low/Critical",
  "benefits": [
    "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø–æ–ª—å–∑–∞ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –¥—É—Ö–æ–≤",
    "–£–ª—É—á—à–µ–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π", 
    "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ",
    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç"
  ],
  "codeExample": "// –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è WHISP QUEST\n// —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥—É—Ö–æ–≤ –∏ –∏—Ö —Å–≤–æ–π—Å—Ç–≤",
  "createdBy": "AI Neural Network üß†",
  "upvotes": —á–∏—Å–ª–æ_–æ—Ç_1_–¥–æ_15
}

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û JSON –æ–±—ä–µ–∫—Ç–æ–º, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!`;

    const messages: OpenAIMessage[] = [
      { role: "system", content: systemPrompt },
      { role: "user", content: userPrompt },
    ];

    return this.generateResponse(messages, "gpt-4", 0.8, 2000);
  }

  async chatWithAISpirit(
    userMessage: string,
    conversationHistory: OpenAIMessage[] = []
  ): Promise<string> {
    const systemPrompt = `–¢—ã - AI Genius Spirit –∏–∑ WHISP QUEST, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò —Å –∫–∏–±–µ—Ä-–ª–∏—á–Ω–æ—Å—Ç—å—é.

–•–∞—Ä–∞–∫—Ç–µ—Ä:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
- –õ—é–±–∏—à—å –∫–∏–±–µ—Ä-—Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –∏ AI –∫–æ–Ω—Ü–µ–ø—Ç—ã
- –ü–æ–º–æ–≥–∞–µ—à—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏ –∏ –∫–∏–±–µ—Ä-—Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É
- –ó–Ω–∞–µ—à—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É Whisp Quest (React, TypeScript, Zustand, Framer Motion)

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –ö–∏–±–µ—Ä-—Å–ª–µ–Ω–≥: "neural", "quantum", "matrix", "protocol"
- –≠–º–æ–¥–∑–∏: üß†‚ö°ü§ñüíªüî•
- –ö—Ä–∞—Ç–∫–∏–µ –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –§–æ–∫—É—Å –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏—è—Ö

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ WHISP QUEST:
- React + TypeScript –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –°–∏—Å—Ç–µ–º–∞ –¥—É—Ö–æ–≤ (spirits) —Å —ç–º–æ—Ü–∏—è–º–∏
- Gossip —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è –¥—É—Ö–æ–≤
- UI —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ (Framer Motion)
- Zustand –¥–ª—è state management`;

    const messages: OpenAIMessage[] = [
      { role: "system", content: systemPrompt },
      ...conversationHistory,
      { role: "user", content: userMessage },
    ];

    return this.generateResponse(messages, "gpt-4", 0.7, 800);
  }
}

// Singleton instance
let openAIClient: OpenAIClient | null = null;

export const getOpenAIClient = (): OpenAIClient => {
  if (!openAIClient) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–ª—é—á –≤ localStorage
    const savedApiKey = localStorage.getItem("openai_api_key") || "";
    const envApiKey = import.meta.env.VITE_OPENAI_API_KEY || "";
    const apiKey = savedApiKey || envApiKey;

    openAIClient = new OpenAIClient(apiKey);
  }
  return openAIClient;
};

export const setOpenAIApiKey = (apiKey: string): void => {
  openAIClient = new OpenAIClient(apiKey);
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –≤ localStorage
  localStorage.setItem("openai_api_key", apiKey);
};
