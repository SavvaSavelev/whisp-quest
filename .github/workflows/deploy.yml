name: ðŸš€ Deploy to Production

on:
  push:
    branches: [ master ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment (ignore checks)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  # ðŸ—ï¸ Build and Verify Production Build
  build-production:
    name: ðŸ—ï¸ Build Production
    runs-on: ubuntu-latest
    
    outputs:
      build-success: ${{ steps.build.outcome }}
      build-hash: ${{ steps.hash.outputs.hash }}
      
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ðŸ” Type Check
        run: npm run type-check
        
      - name: ðŸ§ª Run Tests
        run: npm run test:ci
        env:
          CI: true
          
      - name: ðŸ—ï¸ Build Production
        id: build
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ðŸ”’ Generate Build Hash
        id: hash
        run: |
          BUILD_HASH=$(find dist -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1 | cut -c1-8)
          echo "hash=${BUILD_HASH}" >> $GITHUB_OUTPUT
          echo "ðŸ“ Build hash: ${BUILD_HASH}"
          
      - name: âœ… Verify Build Output
        run: |
          echo "ðŸ” Verifying build output..."
          
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist directory not found"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found"
            exit 1
          fi
          
          if [ ! -d "dist/assets" ]; then
            echo "âŒ Build failed: assets directory not found"
            exit 1
          fi
          
          echo "âœ… Build verification passed"
          echo "ðŸ“ Build output:"
          ls -la dist/
          echo "ðŸ“Š Build size:"
          du -sh dist/
          
      - name: ðŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ steps.hash.outputs.hash }}
          path: dist/
          retention-days: 30

  # ðŸš€ Deploy to GitHub Pages
  deploy-github-pages:
    name: ðŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-production
    if: github.ref == 'refs/heads/master' && needs.build-production.outputs.build-success == 'success'
    
    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: ðŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ needs.build-production.outputs.build-hash }}
          path: dist/
          
      - name: ï¿½ Check Pages Status
        id: check-pages
        run: |
          echo "ðŸ” Checking GitHub Pages configuration..."
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          
      - name: ðŸ“„ Setup Pages Configuration
        id: setup-pages
        uses: actions/configure-pages@v5
        continue-on-error: true
        
      - name: ðŸ“¤ Upload Pages Artifact
        if: steps.setup-pages.outcome == 'success' || steps.setup-pages.outcome == 'skipped'
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/
          
      - name: ðŸš€ Deploy to GitHub Pages
        if: steps.setup-pages.outcome == 'success' || steps.setup-pages.outcome == 'skipped'
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: true
        
      - name: âœ… Deployment Success
        if: steps.deployment.outcome == 'success'
        run: |
          echo "ðŸŽ‰ GitHub Pages deployment successful!"
          echo "ðŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ“ Build hash: ${{ needs.build-production.outputs.build-hash }}"
          echo "ðŸ•’ Deployed at: $(date)"
          echo "::notice title=Deployment Success::Site is live at ${{ steps.deployment.outputs.page_url }}"
          
      - name: ðŸ“ Alternative Deployment Info
        if: steps.deployment.outcome != 'success'
        run: |
          echo "::warning title=Pages Deployment Issue::GitHub Pages deployment failed or is not configured"
          echo "ðŸ”§ Manual setup required:"
          echo "   1. Go to Repository Settings â†’ Pages"
          echo "   2. Source: GitHub Actions"
          echo "   3. Re-run this workflow"
          echo ""
          echo "ðŸ“¦ Build artifacts are available for manual deployment:"
          echo "   - Download from Actions â†’ Artifacts"
          echo "   - Deploy to any static hosting service"
          echo ""
          echo "ðŸŒ Alternative hosting options:"
          echo "   - Netlify: Deploy from build artifact"
          echo "   - Vercel: Connect to GitHub repository"
          echo "   - Firebase Hosting: Use dist/ folder"

  # ðŸ“¦ Create Release Artifacts
  build-release-artifacts:
    name: ðŸ“¦ Build Release Artifacts
    runs-on: ubuntu-latest
    needs: build-production
    if: needs.build-production.outputs.build-success == 'success'
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ needs.build-production.outputs.build-hash }}
          path: dist/
          
      - name: ðŸ“¦ Install Backend Dependencies
        run: |
          cd whisp-server
          npm ci --production
          
      - name: ðŸ”§ Prepare Backend for Production
        run: |
          cd whisp-server
          # Remove dev dependencies and clean up
          rm -rf node_modules/.cache
          find node_modules -name "*.md" -delete
          find node_modules -name "test" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true
          
      - name: ðŸ“ Create Release Archive
        id: create-archive
        run: |
          mkdir -p release
          
          # Copy frontend build
          cp -r dist/ release/frontend/
          
          # Copy backend with production dependencies
          cp -r whisp-server/ release/backend/
          
          # Copy project files
          cp package.json release/
          cp README.md release/
          cp DEPLOYMENT_FIX.md release/ 2>/dev/null || true
          cp PAGES_SETUP.md release/ 2>/dev/null || true
          
          # Determine version for archive name
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="master-$(date +'%Y%m%d')-${{ needs.build-production.outputs.build-hash }}"
          fi
          
          # Create deployment instructions
          cat > release/DEPLOY_INSTRUCTIONS.md << EOF
          # ðŸš€ Whisp Quest Deployment Instructions
          
          ## ðŸ“ Archive Contents:
          - \`frontend/\` - Built React application (ready for static hosting)
          - \`backend/\` - Express.js API server with production dependencies
          - \`package.json\` - Project configuration
          - \`README.md\` - Project documentation
          
          ## ðŸŒ Frontend Deployment (Static Hosting):
          The \`frontend/\` folder contains a fully built React application that can be deployed to:
          - GitHub Pages
          - Netlify
          - Vercel
          - Any static file server
          
          ## ðŸ–¥ï¸ Backend Deployment (Node.js Server):
          \`\`\`bash
          cd backend/
          npm start
          # Server will run on port 3001
          \`\`\`
          
          ## ðŸ”§ Environment Setup:
          Make sure to set these environment variables for the backend:
          - \`OPENAI_API_KEY\` - Your OpenAI API key
          - \`PORT\` - Server port (default: 3001)
          - \`NODE_ENV\` - Set to 'production'
          
          ## ðŸ“Š Build Info:
          - Build Hash: ${{ needs.build-production.outputs.build-hash }}
          - Build Date: $(date)
          - Git Commit: ${{ github.sha }}
          EOF
          
          # Create compressed archive
          tar -czf whisp-quest-${VERSION}.tar.gz -C release .
          
          echo "ðŸ“¦ Created release archive: whisp-quest-${VERSION}.tar.gz"
          echo "ðŸ“Š Archive contents:"
          tar -tzf whisp-quest-${VERSION}.tar.gz | head -20
          echo "ðŸ’¾ Archive size: $(ls -lh whisp-quest-${VERSION}.tar.gz | cut -d' ' -f5)"
          
          # Save version for later steps  
          echo "release_version=${VERSION}" >> $GITHUB_OUTPUT
          echo "archive_name=whisp-quest-${VERSION}.tar.gz" >> $GITHUB_OUTPUT
          
      - name: ðŸ“¤ Upload Release Artifact (Master Builds)
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-archive-${{ steps.create-archive.outputs.release_version }}
          path: whisp-quest-*.tar.gz
          retention-days: 90
          
      - name: ðŸ“ Release Summary (Master)
        if: github.event_name != 'release'
        run: |
          echo "## ðŸ“¦ Release Artifact Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.create-archive.outputs.release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Hash:** \`${{ needs.build-production.outputs.build-hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Archive:** \`${{ steps.create-archive.outputs.archive_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Archive Contents:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend build (React app)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend server (Express API)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployment instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download:** Available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ“¤ Upload Release Asset (Official Releases)
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./${{ steps.create-archive.outputs.archive_name }}
          asset_name: ${{ steps.create-archive.outputs.archive_name }}
          asset_content_type: application/gzip

  # ðŸ“Š Deployment Summary
  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-production, deploy-github-pages, build-release-artifacts]
    if: always() && needs.build-production.outputs.build-success == 'success'
    
    steps:
      - name: ðŸ“‹ Generate Deployment Report
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Hash:** \`${{ needs.build-production.outputs.build-hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** \`$(date)\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build status
          echo "## ðŸ—ï¸ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Production Build:** Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Pages deployment status
          echo "## ðŸŒ GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy-github-pages.result }}" == "success" ]; then
            echo "âœ… **Status:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **URL:** https://savvasavelev.github.io/whisp-quest" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-github-pages.result }}" == "skipped" ]; then
            echo "â­ï¸ **Status:** Skipped (Pages not enabled)" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Action:** Enable Pages in repository settings" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Release artifacts status
          echo "## ðŸ“¦ Release Artifacts" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-release-artifacts.result }}" == "success" ]; then
            echo "âœ… **Status:** Created successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¥ **Download:** Available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Visit your deployed site" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Download release artifacts if needed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Check deployment logs for any issues" >> $GITHUB_STEP_SUMMARY
